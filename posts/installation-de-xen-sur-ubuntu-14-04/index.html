<!doctype html>
<html lang="fr">
  <head>
    <title>Installation de Xen sur Ubuntu 14.04 // vaga.io</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.136.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Fabien CASTERS" />
    <meta name="description" content="Installation et configuration de Xen sur Ubuntu 14.04" />
    <link rel="stylesheet" href="/css/main.min.5b1fcc8902588589c4767187402a3c29f8b8d7a6fdef6d9f8f77045bb0d14fee.css" />
    

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Installation de Xen sur Ubuntu 14.04">
  <meta name="twitter:description" content="Installation et configuration de Xen sur Ubuntu 14.04">

    <meta property="og:url" content="https://vaga.io/posts/installation-de-xen-sur-ubuntu-14-04/">
  <meta property="og:site_name" content="vaga.io">
  <meta property="og:title" content="Installation de Xen sur Ubuntu 14.04">
  <meta property="og:description" content="Installation et configuration de Xen sur Ubuntu 14.04">
  <meta property="og:locale" content="fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2014-07-18T00:00:00+00:00">
    <meta property="article:modified_time" content="2014-07-18T00:00:00+00:00">
    <meta property="article:tag" content="Xen">
    <meta property="article:tag" content="Ubuntu">
    <meta property="article:tag" content="Sysadmin">


  </head>
  <body>
    <header class="app-header">
      <a href="https://vaga.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Fabien CASTERS" /></a>
      <span class="app-header-title">vaga.io</span>
      <p>I write code and I take care about my privacy // Co-founder @ Owaka // Golang lover // Open source enthusiast</p>
      <div class="app-header-social">
        
          <a href="https://github.com/vaga" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-github" viewBox="0 0 24 24" fill="currentColor"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
          </a>
        
          <a href="https://x.com/vaga_io" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-x" viewBox="0 0 24 24" fill="currentColor"><title>X</title><path d="M18.901 1.153h3.68l-8.04 9.19L24 22.846h-7.406l-5.8-7.584-6.638 7.584H.474l8.6-9.83L0 1.154h7.594l5.243 6.932ZM17.61 20.644h2.039L6.486 3.24H4.298Z"/></svg>
          </a>
        
          <a href="https://bsky.app/profile/vaga.io" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-bluesky" viewBox="0 0 24 24" fill="currentColor"><title>Bluesky</title><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.815 2.736 3.713 3.66 6.383 3.364.136-.02.275-.039.415-.056-.138.022-.276.04-.415.056-3.912.58-7.387 2.005-2.83 7.078 5.013 5.19 6.87-1.113 7.823-4.308.953 3.195 2.05 9.271 7.733 4.308 4.267-4.308 1.172-6.498-2.74-7.078a8.741 8.741 0 0 1-.415-.056c.14.017.279.036.415.056 2.67.297 5.568-.628 6.383-3.364.246-.828.624-5.79.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C16.046 4.748 13.087 8.687 12 10.8Z"/></svg>
          </a>
        
          <a href="https://www.linkedin.com/in/fabien-casters/" target="_blank" rel="noreferrer noopener me">
            <svg class="icon icon-brand-linkedin" viewBox="0 0 24 24" fill="currentColor"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Installation de Xen sur Ubuntu 14.04</h1>
      <div class="post-meta">
        <div>
          <svg class="icon icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          Jul 18, 2014
        </div>
        <div>
          <svg class="icon icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>clock</title><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
          5 min read
        </div>
        <div>
          <svg class="icon icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
              <a class="tag" href="https://vaga.io/tags/xen/">Xen</a>
              <a class="tag" href="https://vaga.io/tags/ubuntu/">Ubuntu</a>
              <a class="tag" href="https://vaga.io/tags/sysadmin/">Sysadmin</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>Depuis 3 mois, avec un ami, nous louons un serveur de la gamme IP chez SoYouStart.
C&rsquo;est un serveur de 4 coeurs, 48 Go de RAM et 2 To de disc durs.
Dans cette gamme, on a aussi le droit à 16 IPs.
Nous avons pris cette machine pour pouvoir virtualiser et déployer rapidement nos projets et nos tests.</p>
<p>Ca a un coût mais il me fallait un serveur personnel alors pourquoi pas partager les frais avec quelqu&rsquo;un et se faire plaisir.</p>
<p>Pour la virtualisation, nous avons choisi d&rsquo;installer Xen. C&rsquo;est pourquoi j&rsquo;ai décidé de vous faire partager l&rsquo;installation de notre machine.</p>
<p>On va passé l&rsquo;étape d&rsquo;installation d&rsquo;Ubuntu 14.04 et on s&rsquo;attaque directement à l&rsquo;installation de Xen. :)</p>
<h2 id="installation-de-xen">Installation de Xen</h2>
<p>On commence toujours par un petit :</p>
<pre tabindex="0"><code># apt-get update
# apt-get upgrade
</code></pre><p>Et on installe Xen :</p>
<pre tabindex="0"><code># apt-get install xen-hypervisor
</code></pre><p>Avant de poursuivre, il y a 2 termes à connaître : dom0 et domU.<br>
Le dom0 est la machine physique, la mère des domU.<br>
Le domU est donc les machines virtuelles, les enfants de dom0.</p>
<p>On peut passer à la configuration.</p>
<h2 id="configuration-de-base-du-dom0">Configuration de base du dom0</h2>
<p>Pour commencer, on configure le GRUB pour qu&rsquo;il lance Xen avec Ubuntu. La variable <code>XEN_OVERRIDE_GRUB_DEFAULT</code> nous permet de le faire très simplement. (Elle n&rsquo;existe pas sur Debian) On profite d&rsquo;être dans ce fichier pour limiter la RAM du dom0 à 1Go. Il n&rsquo;a pas besoin de plus.</p>
<pre tabindex="0"><code># vim /etc/default/grub.d/xen.cfg
    XEN_OVERRIDE_GRUB_DEFAULT=1
    GRUB_CMDLINE_XEN=&#34;dom0_mem=1024M&#34;
</code></pre><p>On met le grub à jour.</p>
<pre tabindex="0"><code># update-grub
</code></pre><p>Ensuite, nous avons le choix entre 2 méthodes pour configurer et gérer les VMs : XL et XEND.
Cependant, XEND est une méthode dépreciée par Xen depuis la version 4.1. Donc, on suit et on choisit XL.</p>
<p>Continuons !<br>
On désactive la gestion automatique de la mémoire du dom0 :</p>
<pre tabindex="0"><code># vim /etc/xen/xl.conf
    autoballoon=&#34;0&#34;
</code></pre><p>Lorsqu&rsquo;on regarde dans la documentation de Xen, il nous conseille de désactiver la restauration et la sauvegarde des domU car cela peut poser des problèmes.
Faisons le :</p>
<pre tabindex="0"><code># vim /etc/default/xendomains
    XENDOMAINS_SAVE=
    XENDOMAINS_RESTORE=false
</code></pre><p>Voilà, on a la configuration de base pour notre dom0. On redémarre la machine pour prendre en compte les modifications :</p>
<pre tabindex="0"><code># reboot
</code></pre><p>Nous vérifions grâce à <code>xl list</code> que notre dom0 a bien prit en compte les dernières configurations.</p>
<h2 id="configuration-des-outils-pour-xen">Configuration des outils pour Xen</h2>
<p>On va installer <code>xen-tools</code>. C&rsquo;est un paquet contenant des scripts Perl pour configurer les VMs :</p>
<pre tabindex="0"><code># apt-get install xen-tools
</code></pre><p>Ensuite, on crée un dossier xen dans le /home pour accueillir nos VMs.</p>
<pre tabindex="0"><code># mkdir /home/xen
</code></pre><p>Nous modifions quelques configurations de xen-tools tel que le chemin du dossier contenant les VMs, l&rsquo;architecture et le format de nos VMs.</p>
<pre tabindex="0"><code># vim /etc/xen-tools/xen-tools.conf
    dir = /home/xen
    arch = amd64
    fs = ext4
</code></pre><h2 id="configuration-du-réseau-en-mode-bridge">Configuration du réseau en mode bridge</h2>
<p>Nous avons un serveur qui peut accueillir des VMs. Maintenant, il faut que ces VMs puissent communiquer avec le reste du monde.</p>
<p>On commence par ajouter une interface à notre dom0</p>
<pre tabindex="0"><code># vim /etc/network/interfaces
    auto xenbr0
    iface xenbr0 inet dhcp
        bridge_ports eth0
</code></pre><p>On configure <code>xen-tools</code> au niveau réseau pour nos VMs :</p>
<pre tabindex="0"><code># vim /etc/xen-tools/xen-tools.conf
    gateway    = 94.23.240.254 (IP du dom0 avec 254 à la fin pour les offres SYS)
    netmask    = 255.255.255.255
    broadcast  = 94.23.240.XXX (IP du dom0)
</code></pre><p>Et enfin, on autorise notre dom0 à transmettre les paquets à nos domU :</p>
<pre tabindex="0"><code># vim /etc/sysctl.conf
    net.ipv4.conf.eth0.proxy_arp=1
    net.ipv4.ip_forward=1
# sysctl -p /etc/sysctl.conf
</code></pre><h2 id="création-de-notre-première-vm">Création de notre première VM</h2>
<p>On a écrit un fichier que nous éditons avant chaque création de VM.
C&rsquo;est un bon moyen pour ne pas oublier un paramètre.
Avant de remplir ce fichier, on prend une IP diponible dans le panel de SoYouStart et on génère une adresse MAC virtuelle.</p>
<pre tabindex="0"><code># vim /root/create_vm.sh
    HOSTNAME=&#39;domu.vaga.io&#39;
    IP=&#39;178.32.243.121&#39;
    MAC=&#39;00:00:00:00:00:00&#39;
    BROADCAST=$IP

    DISTRIB=&#39;trusty&#39;

    CPUS=&#39;4&#39;
    RAM=&#39;4096M&#39;
    DISK=&#39;100G&#39;

    xen-create-image --hostname $HOSTNAME --ip $IP --broadcast $BROADCAST --mac $MAC --vcpus $CPUS --memory $RAM --size $DISK --dist $DISTRIB
</code></pre><p>On lance notre script :</p>
<pre tabindex="0"><code># chmod u+x /root/create_vm
# /root/create_vm
</code></pre><p><strong>Attention, on vous donne votre mot de passe root vers la fin.</strong></p>
<p>On va enfin créer et lancer notre première VM :</p>
<pre tabindex="0"><code># xl create /etc/xen/domu.vaga.io
</code></pre><p>Ca y&rsquo;est, notre VM est en place. Avec un <code>xl list</code>, on peut vérifier qu&rsquo;elle tourne avec les bonnes configurations.
Ensuite, on se connecte via :</p>
<pre tabindex="0"><code># xl console domu.vaga.io
</code></pre><p>On se connecte en root avec le mot de passe donné à la fin de l&rsquo;installation. On ajoute les routes nécessaire afin d&rsquo;avoir Internet.</p>
<pre tabindex="0"><code>domU # vi /etc/network/interface
            post-up route add 94.23.240.254 dev eth0
            post-up route add default gw 94.23.240.254
            pre-down route del 94.23.240.254 dev eth0
            pre-down route del default gw 94.23.240.254
</code></pre><p>On reboot la VM.</p>
<pre tabindex="0"><code>domU # reboot
</code></pre><p>On se reconnecte à la VM :</p>
<pre tabindex="0"><code># xl console minecraft.wayt.me
</code></pre><p>On vérifie avec un petit <code>ping google.fr</code>.</p>
<p>Tadaaaa, nous avons notre première VM.<br>
Il reste à securiser les services actifs et à installer d&rsquo;autres services. Mais ca, je vous laisse faire. :)</p>
<p>Une astuce avant de conclure, on peut ajouter un script après la création de la VM. Il faut ajouter l&rsquo;option <code>--role</code> suivi du path du script à la commande <code>xen-create-image</code>. Nous utilisons ce script :</p>
<pre tabindex="0"><code>#!/bin/sh

prefix=$1

if [ -e /usr/share/xen-tools/common.sh ]; then
    . /usr/share/xen-tools/common.sh
else
    echo &#34;Installation problem&#34;
fi

# Add default route
sed &#39;/iface eth0 inet static/a post-up route add 94.23.240.254 dev eth0\n post-up route add default gw 94.23.240.254\n pre-down route del 94.23.240.254 dev eth0\n pre-down route del default gw 94.23.240.254&#39; -i ${prefix}/etc/network/interfaces

# Install munin-node
chroot ${prefix} apt-get update
chroot ${prefix} apt-get install munin-node -y
sed &#39;/allow ^127\\.0\\.0\\.1\$/aallow ^94\\.23\\.240\\.159\$&#39; -i ${prefix}/etc/munin/munin-node.conf

# Install tools
chroot ${prefix} apt-get install vim htop -y
</code></pre><h2 id="conclusion">Conclusion</h2>
<p>Cette idée vient de Maxime et c&rsquo;est une très bonne idée. On ne se pose plus la question d&rsquo;où héberger nos services et nous pouvons tous les séparer pour garder des environnements propres.</p>
<h2 id="quelques-liens">Quelques liens</h2>
<p><a href="http://guide.ovh.com/BridgeClient">OVH : BridgeClient</a><br>
<a href="http://wiki.xenproject.org/wiki/Xen_Project_Best_Practices">Xen Project Best Practices</a><br>
<a href="http://twitter.com/Max_Wayt">Le twitter de Maxime</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
